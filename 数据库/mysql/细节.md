# Mysql零散知识点总集

在学习索引、锁、隔离级别、存储结构等知识时，关注到的一些较为零散的知识点，它们是开发过程中更需要去注重的细节点

> [cyc2018：MySQL](https://www.cyc2018.xyz/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL.html)

> [《MySQL是怎样运行的》](https://book.douban.com/subject/35231266/)：褒贬不一的书，贬低的人觉得它是通过刷评在豆瓣拿9.5，个人觉得相较《高性能Mysql》更简单易懂

# **1. 编解码**

将字符通过**某种规则**，转换为计算机实际存储的二进制数据，称为编码

将计算机实际存储的二进制数据，通过**某种规则**转换为字符的过程，称为解码

## **1.1 字符集**

上述的规则就是字符集，通过不同的字符集编码，字符实际存储的二进制数据将不一致，解码同理

而在不同字符集中，字符大小基本单位为**字节**，字符可能占N个字节大小，即（8 * N）个比特位

> 如果读取字节序列时，如何区分某个字节代表的是单独字符还是某个字符的一部分？

**ASCII字符集只收录128个字符，使用0~127，即后七位就可以表示全部的字符，所以第1位用来标识是否多字节字符，0表示单字节，1表示多字节**
    
`乱码问题`：对同一份二进制数据的解码方式不一致，出现字符错乱问题

### **1.1.1 ASCII**

包含：128个字符，包括空格、标点符号、数字、大小写字母和一些不可见字符

编码方式：采用定长编码方式，每个字符占1字节大小

    在后续的字符集中，都有兼容ASCII编码

### **1.1.2 utf8mb4**

包含：utf8字符集几乎收录了当今世界各个国家/地区的字符，兼容ASCII字符集

编码方式：采用变长编码方式，每个字符占1~4字节大小

在Mysql中，有两种utf8的字符集：
- utf8
- utf8mb4

utf8mb4才是完整的utf8字符集，单字符占1~4个字节；而utf8也可以称为utf8mb3，是阉割过的UTF-8字符集，只用1~3字节表示字符

> [UTF-8是如何编码的？](https://blog.csdn.net/weixin_33895475/article/details/92317160)：讲解了utf8对于字节序列的读取规则

- 如果第一个字节以0开始，代表是一个单字节字符
- 如果第一个字节以110开始，代表是双字节字符
- 如果第一个字节以1110开始，代表是三字节字符
- 如果第一个字节以11110开始，代表是四字节字符
- 如果第一个字节以111110开始，代表是五字节字符
- 如果第一个字节以1111110开始，代表是六字节字符

## **1.2 字符比较规则**

在确定了字符和二进制数据的编解码规则（字符集）之后，需要有**字符比较规则**规定不同字符的大小

    比如：字符'a'编码为0x01，字符'b'编码为0x02，所以'a'小于'b'，这种比较规则称为二进制比较规则

`常用字符校对规则`：utf8mb4_bin（二进制，区分大小写）/ utf8mb4_general_ci（大小写不敏感）

比较规则优先级：字段 > 表 > 数据库 > 数据库系统，如果没有指定的话，则将上一层的校对规则作为默认规则

## **1.3 字符集转换**

在客户端与服务器做数据交互时，如果遇到双方字符集不一致时，通过以下方式进行**字符集转换**：

> 每个客户端与服务器建立连接后，服务器都会为该客户端维护单独的character_set_client、character_set_connection和character_set_results变量，用以解码客户端的字节序列，和返回客户端字节序列数据，这两个变量都是SESSION级别的

第一步： 从客户端发送的字节序列是采用哪种字符集编码的

    取决于客户端启动时设置的default-character-set启动选项有关

第二步： 服务器**接受**请求字节序列后，认为是哪种字符集编码的

    取决于服务器对会话维护的character_set_client的值，此时并没有真正的处理sql请求，只是单纯将字节序列解码为sql请求

第三步： 服务器**处理**请求字节序列时，认为应该用哪种字符集处理

    取决于服务器对会话所维护的character_set_connection变量，指定sql请求中的参数使用的字符集，才能做处理

第四步： 服务器在向客户端返回字节序列时，以哪种字符集编码的

    取决于服务器系统变量character_set_results

第五步： 客户端在收到字节序列后，如何解码

    取决于客户端操作系统的字符集，与客户端启动的default-character-set启动选项有关

# **2. 数据类型**

在设计库表结构时，应遵循硬盘空间利用率原则，尽可能地缩小行记录的大小，以使得每一页可以存储更多的行记录，提升I/O效率

正常类型指定列宽即指定其存储大小，整型除外

## **2.1 整型**

注意点：在符合业务需求场景下，越小的列越好

取值范围：INT表示各个位的值直接相加，所以表示的范围是-2^31 ~ 2^31 - 1，第一位作为符号位

存储空间：

- TINYINT：8位，1字节
- SMALLINT：16位，2字节
- MEDIUMINT：24位，3字节
- INT：32位，4字节
- BIGINT：64位，8字节

指定列宽：INT(N)中的N只是规定了交互工具显示字符的个数，对于**存储和计算**没有实际意义

## **2.2 浮点数**

注意点：FLOAT、DOUBLE是浮点运算，DECIMAL是定点运算

> [浮点运算是什么？](https://www.zhihu.com/question/19907406/answer/612947177)：浮点运算有什么好处呢？对于32位宽来说，它支持最大的数是2^32，支持最小的精度是2^(-32)。这就比定点数的在同样位宽的情况下表达力更强了

取值范围（为什么Float和Int都是4个字节，但是取值范围却不一样）：因为FLOAT表示8位指数和23位底数位，所以表示的范围是-(2^23)^127 ~ (2^23)^127，第一位同样作为符号位

存储空间：

- FLOAT：32位，4字节大小
- DOUBLE：64位， 8字节大小
- DECIMAL(M, D)：(M / 2) + 1字节大小，M的范围是[1, 65]，D的范围是[0, 33]，即最大32字节

    DECIMAL是高精度小数类型，CPU原生支持浮点运算，但不支持DECIMAL类型运算，所以计算起来比FLOAT和DOUBLE付出更高代价

指定列宽：FLOAT、DOUBLE和DECIMAL都可以**指定列宽**，且对存储和计算有实际意义。例如DECIMAL(18, 9)表示总共显示18位，取9位显示小数，剩下9位存储整数部分

    阿里开发规约：禁止使用float和double，因为存在精度损失问题，可能在值比较时得不到正确的结果，如果存储的数据超过decimal范围的，将数据拆分成整数和小数分开存储

## **2.3 字符串**

注意点：CHAR是定长的，VARCHAR是变长的，**在存储和检索时，会保留VARCHAR末尾的空格，删除CHAR末尾的空格**

长度范围：
- CHAR：255
- VARCHAR：0 ~ 65535（具体看其他字段已占用的字节数）

存储空间：

- CHAR：指定长度，定长
- VARCHAR：指定长度，变长

    变长类型能够节省空间，当超过一个页能容纳大小时，使用溢出页（off-page）存储

## **2.4 时间和日期**

> [MySQL 中 datetime 和 timestamp 的区别与选择](https://segmentfault.com/a/1190000017393602)

注意点：存储范围不同，存储大小也不同，更常用datetime

日期范围：
- timestamp：'1970-01-01 00:00:01.000000' to '2038-01-19 03:14:07.999999'
- datetime：'1000-01-01 00:00:00.000000' to '9999-12-31 23:59:59.999999'

存储空间：
- timestamp：4字节
- datetime：8字节

时区：
- timestamp：以utc格式储存，会自动检索当前时区并进行转换
- datetime：不会进行时区的检索

datetime选择基准：
- 日期范围需要超过时间戳的，使用datetime
- 服务器之间的时区不同，使用datetime

timestamp选择基准：
- 想使用自动插入时间的，使用timestamp
- 根据时区自动更新时间的，使用timestamp