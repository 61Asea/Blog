# Mysql（五）：单机/集群一致性

在学习了日志系统之后，感受到了binlog的宕机恢复的重要性，这也衍生出对Mysql单机一致/Mysql主从一致/Redis和Mysql一致性的一系列疑问，在这里先解决掉上述的前两个问题

> [Mysql（四）：运作机制](https://asea-cch.life/achrives/)

binlog是Mysql实现数据一致性的重要机制，其基本核心作用是：**复制和备份**

# **1. 单机一致**

取决于redo和binlog对数据落地策略

## **1.1 最强安全性的策略**

```sql
set global variable innodb_flush_log_at_trx_commit = 1;

set global variable sync_binlog = 1;
```

redo：每次事务提交时，都会提交到os buffer中，并调用fsync()刷盘

binlog：每次事务提交时，都会将binlog_cache中的数据强制写入到磁盘中

## **1.2 兼顾性能的安全性策略**

```sql
set global variable innodb_flush_log_at_trx_commit = 2;

set global variable innodb_flush_log_at_timeout = 1;

set global variable sync_binlog = 1;
```

redo：每次事务提交时，提交到os buffer中，异步线程会在每秒调用一次fsync()进行刷盘（可以极大提升性能，但是会系统宕机时丢失1s的数据）

binlog：如1.1策略

    单机的容错性极低，如果发生硬件/断电等不可抗力因素，单点将面临数据丢失以及服务完全不可用的问题，所以生产模式不可能为单实例

# **2. 主从（集群）一致**

Mysql集群通常指代Mysql的主从复制架构，下面默认以**一主二从**的视角进行总结

通常使用主从复制来解决单点故障的问题，其通过binlog机制将主库的变更同步到从库中

    只要涉及到分布式系统设计，必须就要权衡CAP，一般系统都遵循：高可用，弱一致

所以根据不同的系统要求设计，Mysql的主从复制分为：
- 异步复制
- 半同步复制
- 全同步复制

不同模式下的数据一致性能力不同，下面进行总结

## **2.1 异步复制**

## **2.2 半同步复制**

## **2.3 全同步复制**

# 参考

- [Mysql主从模式的数据一致性](https://www.jianshu.com/p/790a158d9eb3)