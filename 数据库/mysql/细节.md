# Mysql应注意的一些细节

在学习索引、锁、隔离级别、存储结构等知识时，关注到的一些较为零散的知识点，它们是开发过程中更需要去注重的细节点

> [cyc2018：MySQL](https://www.cyc2018.xyz/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL.html)

> [《MySQL是怎样运行的》](https://book.douban.com/subject/35231266/)：褒贬不一的书，坏的人觉得它是通过刷评在豆瓣拿9.5，个人觉得相较《高性能Mysql》更简单易懂

# **1. 编解码**

将字符通过**某种规则**，转换为计算机实际存储的二进制数据，称为编码

将计算机实际存储的二进制数据，通过**某种规则**转换为字符的过程，称为解码

## **1.1 字符集**

上述的规则就是字符集，通过不同的字符集编码，字符实际存储的二进制数据将不一致，解码同理

而在不同字符集中，字符大小基本单位为**字节**，字符可能占N个字节大小，即（8 * N）个比特位

> 如果读取字节序列时，如何区分某个字节代表的是单独字符还是某个字符的一部分？

**ASCII字符集只收录128个字符，使用0~127，即后七位就可以表示全部的字符，所以第1位用来标识是否多字节字符，0表示单字节，1表示多字节**
    
`乱码问题`：对同一份二进制数据的解码方式不一致，出现字符错乱问题

### **1.1.1 ASCII**

包含：128个字符，包括空格、标点符号、数字、大小写字母和一些不可见字符

编码方式：采用定长编码方式，每个字符占1字节大小

    在后续的字符集中，都有兼容ASCII编码

### **1.1.2 utf8mb4**

包含：utf8字符集几乎收录了当今世界各个国家/地区的字符，兼容ASCII字符集

编码方式：采用变长编码方式，每个字符占1~4字节大小

在Mysql中，有两种utf8的字符集：
- utf8
- utf8mb4

utf8mb4才是完整的utf8字符集，单字符占1~4个字节；而utf8也可以称为utf8mb3，是阉割过的UTF-8字符集，只用1~3字节表示字符

> [UTF-8是如何编码的？](https://blog.csdn.net/weixin_33895475/article/details/92317160)：讲解了utf8对于字节序列的读取规则

- 如果第一个字节以0开始，代表是一个单字节字符
- 如果第一个字节以110开始，代表是双字节字符
- 如果第一个字节以1110开始，代表是三字节字符
- 如果第一个字节以11110开始，代表是四字节字符
- 如果第一个字节以111110开始，代表是五字节字符
- 如果第一个字节以1111110开始，代表是六字节字符

## **1.2 字符比较规则**

在确定了字符和二进制数据的编解码规则（字符集）之后，需要有**字符比较规则**规定不同字符的大小

    比如：字符'a'编码为0x01，字符'b'编码为0x02，所以'a'小于'b'，这种比较规则称为二进制比较规则

`常用字符校对规则`：utf8mb4_bin（二进制，区分大小写）/ utf8mb4_general_ci（大小写不敏感）

比较规则优先级：字段 > 表 > 数据库 > 数据库系统，如果没有指定的话，则将上一层的校对规则作为默认规则

## **1.3 字符集转换**

在客户端与服务器做数据交互时，如果遇到双方字符集不一致时，通过以下方式进行**字符集转换**：

    每个客户端与服务器建立连接后，服务器都会为该客户端维护单独的character_set_client和character_set_results变量，用以解码客户端的字节序列，和返回客户端字节序列数据
    
    这两个变量都是SESSION级别的

1. 从客户端发送的字节序列是采用哪种字符集编码的

    取决于客户端启动时设置的default-character-set启动选项有关

2. 服务器**接受**请求字节序列后，认为是哪种字符集编码的

    取决于服务器对会话维护的**character_set_client**的值

3. 服务器**处理**请求字节序列时，认为应该用哪种字符集处理

    取决于服务器对会话所维护的character_set_connection变量

4. 服务器在向客户端返回字节序列时，以哪种字符集编码的

    取决于服务器系统变量character_set_results

5. 客户端在收到字节序列后，如何解码

    取决于客户端操作系统的字符集，与客户端启动的default-character-set启动选项有关


